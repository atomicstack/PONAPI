package PONAPI::Client::UA::YAHC;

################################################################################
################################################################################

use strict;
use warnings;

use Moose;
use YAHC;

with 'PONAPI::Client::Role::UA';

################################################################################
################################################################################

has yahc => (
    is  => 'rw',
    isa => 'Ref',
    lazy_build => 1,
);

has yahc_storage => (
    is  => 'rw',
    isa => 'Ref',
);

has scheme => (
    is  => 'rw',
    isa => 'Str',
);

################################################################################
################################################################################

sub _build_yahc {
    my ($self) = @_;
    my ($yahc, $yahc_storage) = YAHC->new();

    $self->yahc_storage($yahc_storage);
    return $yahc;
}

################################################################################
################################################################################

sub send_http_request {
    my ($self, $request) = @_;

    my ($response, $status_code, $error_string);

    my $callback = sub {
        ($response, $status_code, $error_string) = @_;
    };

    local $request->{callback} = $callback;
    local $request->{scheme} = $self->scheme;

    my $yahc = $self->yahc;

    $yahc->request($request);
    $yahc->run();

    my $ponapi_response = {
        status => $status_code,
        head   => $response->{head},
        body   => $response->{body},
    };

    return $ponapi_response;
}

################################################################################
################################################################################

sub before_request { }

################################################################################
################################################################################

sub after_request { }

################################################################################
################################################################################

no Moose;
__PACKAGE__->meta->make_immutable();

1;

################################################################################
################################################################################
